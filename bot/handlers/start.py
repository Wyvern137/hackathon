"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start –∏ /help
"""
import logging
from telegram import Update
from telegram.ext import ContextTypes

from bot.keyboards.main_menu import get_main_menu_keyboard
from bot.keyboards.inline import get_nko_setup_start_keyboard
from bot.utils.helpers import get_or_create_user
from bot.database.models import NKOProfile
from bot.database.database import get_db

logger = logging.getLogger(__name__)


async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
    
    –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å–æ–∑–¥–∞–µ—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç –µ–≥–æ –≤ –ë–î –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    """
    user = update.effective_user
    chat = update.effective_chat
    
    if not user:
        return
    
    # –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –ø–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
    db_user = get_or_create_user(
        user_id=user.id,
        username=user.username,
        first_name=user.first_name or "",
        last_name=user.last_name,
        language_code=user.language_code or "ru"
    )
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –ù–ö–û
    with get_db() as db:
        nko_profile = db.query(NKOProfile).filter(NKOProfile.user_id == user.id).first()
        has_profile = nko_profile is not None and nko_profile.is_complete
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è –¥–ª—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
    user_name = user.first_name or user.username or "–¥—Ä—É–≥"
    # –û—á–∏—â–∞–µ–º –∏–º—è –æ—Ç —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤ Markdown, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —Å–ª–æ–º–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    user_name = user_name.replace("*", "").replace("_", "").replace("[", "").replace("]", "").replace("`", "")
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    welcome_text = f"""üëã –ü—Ä–∏–≤–µ—Ç, {user_name}!

–Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Ç–≤–æ–µ–π –Ω–µ–∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏.

üéØ **–ß—Ç–æ —è —É–º–µ—é:**
‚Ä¢ üìù –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç—ã –ø–æ—Å—Ç–æ–≤ (—Å–≤–æ–±–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞, –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–∏–º–µ—Ä–æ–≤)
‚Ä¢ üé® –°–æ–∑–¥–∞–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –ø–æ—Å—Ç–æ–≤ —Å –ø–æ–º–æ—â—å—é AI
‚Ä¢ ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ —É–ª—É—á—à–∞—Ç—å —Ç–µ–∫—Å—Ç—ã (–æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—è, –≥—Ä–∞–º–º–∞—Ç–∏–∫–∞, —Å—Ç–∏–ª—å)
‚Ä¢ üìÖ –°–æ–∑–¥–∞–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω—ã –Ω–∞ –∑–∞–¥–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥

üìå **–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:**"""
    
    if not has_profile:
        welcome_text += "\n\nüí° *–°–æ–≤–µ—Ç:* –°–æ–∑–¥–∞–π –ø—Ä–æ—Ñ–∏–ª—å —Å–≤–æ–µ–π –ù–ö–û, —á—Ç–æ–±—ã —è –º–æ–≥ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç! –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ üëá"
        await update.message.reply_text(
            welcome_text,
            reply_markup=get_main_menu_keyboard(),
            parse_mode="Markdown"
        )
        await update.message.reply_text(
            "–•–æ—á–µ—à—å —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å —Å–≤–æ–µ–π –ù–ö–û? –Ø –∑–∞–¥–∞–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤, —á—Ç–æ–±—ã –ª—É—á—à–µ –ø–æ–Ω–∏–º–∞—Ç—å —Ç–≤–æ—é –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é.",
            reply_markup=get_nko_setup_start_keyboard()
        )
    else:
        org_name = nko_profile.organization_name if nko_profile else None
        if org_name:
            welcome_text += f"\n\nüè¢ –¢–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å: *{org_name}*"
        
        await update.message.reply_text(
            welcome_text,
            reply_markup=get_main_menu_keyboard(),
            parse_mode="Markdown"
        )
    
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.id} ({user.username or user.first_name}) –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞")


async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help
    
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø—Ä–∞–≤–∫—É –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–æ—Ç–∞
    """
    help_text = """üìö **–°–ø—Ä–∞–≤–∫–∞ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–æ—Ç–∞**

üéØ **–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

üìù **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞**
‚Ä¢ –°–≤–æ–±–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç - –≤–≤–µ–¥–∏ –∏–¥–µ—é, —è –ø–µ—Ä–µ–ø–∏—à—É –µ—ë –≤ –≥–æ—Ç–æ–≤—ã–π –ø–æ—Å—Ç
‚Ä¢ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞ - –æ—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, —è —Å–æ–∑–¥–∞–º –ø–æ—Å—Ç
‚Ä¢ –ù–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–∏–º–µ—Ä–æ–≤ - –ø—Ä–∏—à–ª–∏ –ø—Ä–∏–º–µ—Ä—ã –ø–æ—Å—Ç–æ–≤, —è —Å–æ–∑–¥–∞–º –ø–æ—Ö–æ–∂–∏–π —Å—Ç–∏–ª—å

üé® **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è**
‚Ä¢ –û–ø–∏—à–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å—ã
‚Ä¢ –í—ã–±–µ—Ä–∏ —Å—Ç–∏–ª—å –∏ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω
‚Ä¢ –ü–æ–ª—É—á–∏ –≥–æ—Ç–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ

‚úèÔ∏è **–†–µ–¥–∞–∫—Ç–æ—Ä —Ç–µ–∫—Å—Ç–∞**
‚Ä¢ –ü—Ä–∏—à–ª–∏ —Ç–µ–∫—Å—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
‚Ä¢ –ü–æ–ª—É—á–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é

üìÖ **–ö–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω**
‚Ä¢ –í—ã–±–µ—Ä–∏ –ø–µ—Ä–∏–æ–¥ –∏ —á–∞—Å—Ç–æ—Ç—É –ø—É–±–ª–∏–∫–∞—Ü–∏–π
‚Ä¢ –ü–æ–ª—É—á–∏ –≥–æ—Ç–æ–≤—ã–π –ø–ª–∞–Ω –ø—É–±–ª–∏–∫–∞—Ü–∏–π

üìä **–ò—Å—Ç–æ—Ä–∏—è**
‚Ä¢ –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π –≤—Å–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
‚Ä¢ –°–æ—Ö—Ä–∞–Ω—è–π –∏–∑–±—Ä–∞–Ω–Ω–æ–µ

‚öôÔ∏è **–ù–∞—Å—Ç—Ä–æ–π–∫–∏**
‚Ä¢ –ù–∞—Å—Ç—Ä–æ–π –ø—Ä–æ—Ñ–∏–ª—å –ù–ö–û
‚Ä¢ –í–∫–ª—é—á–∏/–≤—ã–∫–ª—é—á–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –ø—É–±–ª–∏–∫–∞—Ü–∏—è—Ö

üí° **–°–æ–≤–µ—Ç—ã:**
‚Ä¢ –ó–∞–ø–æ–ª–Ω–∏ –ø—Ä–æ—Ñ–∏–ª—å –ù–ö–û –¥–ª—è –±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–Ω—ã–µ —Å—Ç–∏–ª–∏ –Ω–∞–ø–∏—Å–∞–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
‚Ä¢ –°–æ—Ö—Ä–∞–Ω—è–π –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è –ø–æ—Å—Ç—ã –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ

‚ùì –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã, –Ω–∞–ø–∏—à–∏ /start –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
    
    await update.message.reply_text(help_text, parse_mode="Markdown")


async def about_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–û –±–æ—Ç–µ"
    """
    about_text = """‚ÑπÔ∏è **–û –±–æ—Ç–µ**

–Ø - Telegram-–±–æ—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –Ω–µ–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π.

üéØ **–¶–µ–ª—å –ø—Ä–æ–µ–∫—Ç–∞:**
–ü–æ–º–æ—á—å –ù–ö–û —Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π –∏ —Å–∞–π—Ç–æ–≤, —ç–∫–æ–Ω–æ–º—è –≤—Ä–µ–º—è –∏ —É—Å–∏–ª–∏—è.

‚ú® **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –∏ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö AI-–º–æ–¥–µ–ª–µ–π
‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
‚Ä¢ –ü—Ä–æ—Å—Ç–æ–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
‚Ä¢ –ú–∏–Ω–∏–º—É–º –∫–ª–∏–∫–æ–≤ - –º–∞–∫—Å–∏–º—É–º –ø–æ–ª—å–∑—ã

üí° **–î–ª—è –∫–æ–≥–æ:**
‚Ä¢ –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –ù–ö–û
‚Ä¢ –í–æ–ª–æ–Ω—Ç—ë—Ä—ã
‚Ä¢ SMM-–º–µ–Ω–µ–¥–∂–µ—Ä—ã –Ω–µ–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤

üìå –†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ –¥–ª—è —Ö–∞–∫–∞—Ç–æ–Ω–∞ –ø–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã –ù–ö–û"""
    
    await update.message.reply_text(about_text, parse_mode="Markdown")

