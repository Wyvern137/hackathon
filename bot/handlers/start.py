"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start –∏ /help
"""
import logging
from datetime import datetime, timedelta
from telegram import Update
from telegram.ext import ContextTypes, CallbackQueryHandler

from bot.keyboards.main_menu import get_main_menu_keyboard
from bot.keyboards.inline import (
    get_nko_setup_start_keyboard, 
    get_quick_start_keyboard,
    get_demo_examples_keyboard,
    get_achievements_keyboard
)
from bot.utils.helpers import get_or_create_user
from bot.database.models import User, NKOProfile, ContentHistory, ContentPlan, PostTemplate
from bot.database.database import get_db
from bot.services.ai.speech_recognition import speech_recognition_service

logger = logging.getLogger(__name__)


def get_user_statistics(user_id: int) -> dict:
    """
    –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    Args:
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
    """
    with get_db() as db:
        # –ü–æ–¥—Å—á–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø–æ —Ç–∏–ø–∞–º
        texts_count = db.query(ContentHistory).filter(
            ContentHistory.user_id == user_id,
            ContentHistory.content_type == "text"
        ).count()
        
        images_count = db.query(ContentHistory).filter(
            ContentHistory.user_id == user_id,
            ContentHistory.content_type == "image"
        ).count()
        
        plans_count = db.query(ContentPlan).filter(
            ContentPlan.user_id == user_id
        ).count()
        
        templates_count = db.query(PostTemplate).filter(
            PostTemplate.user_id == user_id
        ).count()
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
        week_ago = datetime.now() - timedelta(days=7)
        recent_texts = db.query(ContentHistory).filter(
            ContentHistory.user_id == user_id,
            ContentHistory.content_type == "text",
            ContentHistory.generated_at >= week_ago
        ).count()
        
        recent_images = db.query(ContentHistory).filter(
            ContentHistory.user_id == user_id,
            ContentHistory.content_type == "image",
            ContentHistory.generated_at >= week_ago
        ).count()
        
        # –í—Å–µ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        total_content = texts_count + images_count
        
    return {
        "texts_count": texts_count,
        "images_count": images_count,
        "plans_count": plans_count,
        "templates_count": templates_count,
        "total_content": total_content,
        "recent_texts": recent_texts,
        "recent_images": recent_images
    }


def get_achievements(user_id: int, stats: dict) -> list:
    """
    –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    Args:
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        stats: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    Returns:
        –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
    """
    achievements = []
    
    if stats["total_content"] >= 1:
        achievements.append("üéØ –ü–µ—Ä–≤—ã–π —à–∞–≥ - —Å–æ–∑–¥–∞–Ω –ø–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç!")
    if stats["texts_count"] >= 5:
        achievements.append("üìù –ú–∞—Å—Ç–µ—Ä —Å–ª–æ–≤ - —Å–æ–∑–¥–∞–Ω–æ 5 –ø–æ—Å—Ç–æ–≤!")
    if stats["texts_count"] >= 10:
        achievements.append("‚ú® –ü–æ—Å—Ç–º–µ–π–∫–µ—Ä - —Å–æ–∑–¥–∞–Ω–æ 10 –ø–æ—Å—Ç–æ–≤!")
    if stats["images_count"] >= 5:
        achievements.append("üé® –•—É–¥–æ–∂–Ω–∏–∫ - —Å–æ–∑–¥–∞–Ω–æ 5 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π!")
    if stats["plans_count"] >= 1:
        achievements.append("üìÖ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ - —Å–æ–∑–¥–∞–Ω –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω!")
    if stats["total_content"] >= 50:
        achievements.append("üèÜ –õ–µ–≥–µ–Ω–¥–∞ - —Å–æ–∑–¥–∞–Ω–æ 50 –ø–æ—Å—Ç–æ–≤!")
    
    return achievements


async def show_demo_examples(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤
    """
    query = update.callback_query
    await query.answer()
    
    callback_data = query.data
    
    examples = [
        {
            "style": "üí¨ –†–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —Å—Ç–∏–ª—å",
            "text": """–°–µ–≥–æ–¥–Ω—è —É –Ω–∞—Å –≤–∞–∂–Ω–∞—è –Ω–æ–≤–æ—Å—Ç—å! –í –ø—Ä–∏—é—Ç–µ –ø–æ—è–≤–∏–ª–∏—Å—å –Ω–æ–≤—ã–µ –∂–∏–ª—å—Ü—ã ‚Äî –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–±–∞–∫ –Ω–∞—à–ª–∏ —Å–≤–æ–π –¥–æ–º.

–≠—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –∂–∏–≤–æ—Ç–Ω—ã–µ. –≠—Ç–æ –Ω–æ–≤—ã–µ —á–ª–µ–Ω—ã –Ω–∞—à–µ–π –±–æ–ª—å—à–æ–π —Å–µ–º—å–∏. –ú—ã —É–∂–µ –Ω–∞—á–∞–ª–∏ –∑–∞–±–æ—Ç–∏—Ç—å—Å—è –æ –Ω–∏—Ö: –≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä–Ω—ã–π –æ—Å–º–æ—Ç—Ä, —É—é—Ç–Ω–æ–µ –º–µ—Å—Ç–æ –¥–ª—è –∂–∏–∑–Ω–∏, –≤–Ω–∏–º–∞–Ω–∏–µ –∏ –ª–∞—Å–∫–∞.

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å ‚Äî –∑–∞—Ö–æ–¥–∏ –≤ –≥–æ—Å—Ç–∏. –ë—É–¥–µ–º —Ä–∞–¥—ã!

#–ø–æ–º–æ—â—å–∂–∏–≤–æ—Ç–Ω—ã–º #–ø—Ä–∏—é—Ç #–±–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å"""
        },
        {
            "style": "üìä –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å",
            "text": """–í–æ–ª–æ–Ω—Ç–µ—Ä—Å–∫–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≤–æ–¥–∏—Ç –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ –∑–∞–Ω—è—Ç–∏—è –ø–æ —ç–∫–æ–ª–æ–≥–∏–∏ –¥–ª—è –¥–µ—Ç–µ–π.

–ü—Ä–æ–≥—Ä–∞–º–º–∞ –≤–∫–ª—é—á–∞–µ—Ç —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–Ω—è—Ç–∏—è, –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã –∏ —ç–∫—Å–∫—É—Ä—Å–∏–∏ –Ω–∞ –ø—Ä–∏—Ä–æ–¥—É. –ó–∞–Ω—è—Ç–∏—è –ø—Ä–æ—Ö–æ–¥—è—Ç –∫–∞–∂–¥—É—é —Å—É–±–±–æ—Ç—É —Å 10:00 –¥–æ 12:00.

–î–ª—è —É—á–∞—Å—Ç–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è.

#—ç–∫–æ–ª–æ–≥–∏—è #–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ #–¥–µ—Ç—è–º"""
        },
        {
            "style": "üòä –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π —Å—Ç–∏–ª—å",
            "text": """–ü—Ä–∏–≤–µ—Ç, –¥—Ä—É–∑—å—è! 

–•–æ—Ç–∏–º –ø–æ–¥–µ–ª–∏—Ç—å—Å—è —Ö–æ—Ä–æ—à–µ–π –Ω–æ–≤–æ—Å—Ç—å—é ‚Äî –Ω–∞—à –ø—Ä–æ–µ–∫—Ç –ø–æ–ª—É—á–∏–ª –ø–æ–¥–¥–µ—Ä–∂–∫—É! –≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –º—ã —Å–º–æ–∂–µ–º –ø–æ–º–æ—á—å –µ—â–µ –±–æ–ª—å—à–µ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ª—é–¥–µ–π.

–°–ø–∞—Å–∏–±–æ –≤—Å–µ–º, –∫—Ç–æ –≤–µ—Ä–∏–ª –≤ –Ω–∞—Å –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–ª –Ω–∞ —ç—Ç–æ–º –ø—É—Ç–∏. –í–º–µ—Å—Ç–µ –º—ã –¥–µ–ª–∞–µ–º –º–∏—Ä –ª—É—á—à–µ!

#–±–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å #–Ω–æ–≤–æ—Å—Ç–∏ #—Å–ø–∞—Å–∏–±–æ"""
        }
    ]
    
    # –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—à–µ–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã, –¥–æ–±–∞–≤–ª—è–µ–º –µ—â–µ
    if callback_data == "show_more_examples":
        examples.extend([
            {
                "style": "‚ú® –•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å",
                "text": """–í —Ç–∏—à–∏–Ω–µ –≤–µ—á–µ—Ä–Ω–µ–≥–æ –Ω–µ–±–∞ –∑–∞–∂–∏–≥–∞—é—Ç—Å—è –∑–≤–µ–∑–¥—ã –Ω–∞–¥–µ–∂–¥—ã. 

–ö–∞–∂–¥–æ–µ –º–∞–ª–µ–Ω—å–∫–æ–µ –¥–æ–±—Ä–æ–µ –¥–µ–ª–æ ‚Äî —ç—Ç–æ –∫–∞–ø–ª—è –≤ –æ–∫–µ–∞–Ω–µ –º–∏–ª–æ—Å–µ—Ä–¥–∏—è. –°–µ–≥–æ–¥–Ω—è –º—ã —Å—Ç–∞–ª–∏ —Å–≤–∏–¥–µ—Ç–µ–ª—è–º–∏ —á—É–¥–∞: —Å–µ—Ä–¥—Ü–∞ –ª—é–¥–µ–π –æ—Ç–∫—Ä—ã–ª–∏—Å—å –Ω–∞–≤—Å—Ç—Ä–µ—á—É —Ç–µ–º, –∫—Ç–æ –Ω—É–∂–¥–∞–µ—Ç—Å—è –≤ –ø–æ–º–æ—â–∏.

–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ –Ω–∞—à–µ–º—É –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—é –¥–æ–±—Ä–∞.

#–¥–æ–±—Ä–æ #–º–∏–ª–æ—Å–µ—Ä–¥–∏–µ #–Ω–∞–¥–µ–∂–¥–∞"""
            },
            {
                "style": "üìÑ –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å",
                "text": """–£–≤–µ–¥–æ–º–ª—è–µ–º –æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–∏ –µ–∂–µ–≥–æ–¥–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–Ω–æ–≥–æ —Å–æ–±—Ä–∞–Ω–∏—è –Ω–µ–∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏.

–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ —Å–æ—Å—Ç–æ–∏—Ç—Å—è 15 –¥–µ–∫–∞–±—Ä—è 2024 –≥–æ–¥–∞ –≤ 18:00 –ø–æ –∞–¥—Ä–µ—Å—É: —É–ª. –ú–∏—Ä–∞, –¥. 10.

–ù–∞ –ø–æ–≤–µ—Å—Ç–∫–µ –¥–Ω—è: –æ—Ç—á–µ—Ç –æ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–∞ —Ç–µ–∫—É—â–∏–π –≥–æ–¥, –ø–ª–∞–Ω—ã –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –≥–æ–¥, –≤—ã–±–æ—Ä—ã —Ä—É–∫–æ–≤–æ–¥—è—â–µ–≥–æ —Å–æ—Å—Ç–∞–≤–∞.

–ü—Ä–∏–≥–ª–∞—à–∞–µ–º –≤—Å–µ—Ö –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω–Ω—ã—Ö –ª–∏—Ü.

#–Ω–∫–æ #–æ—Ç—á–µ—Ç #—Å–æ–±—Ä–∞–Ω–∏–µ"""
            }
        ])
    
    text = "üìö **–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –ø–æ—Å—Ç–æ–≤**\n\n"
    text += "–í–æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∏–º–µ—Ä–æ–≤ –ø–æ—Å—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —è –º–æ–≥—É —Å–æ–∑–¥–∞—Ç—å:\n\n"
    
    for i, example in enumerate(examples, 1):
        text += f"**{example['style']}**\n"
        text += f"{example['text']}\n\n"
        if i < len(examples):
            text += "---\n\n"
    
    text += "üí° *–•–æ—á–µ—à—å —Å–æ–∑–¥–∞—Ç—å –ø–æ—Ö–æ–∂–∏–π –ø–æ—Å—Ç? –ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ!*"
    
    await query.edit_message_text(
        text,
        reply_markup=get_demo_examples_keyboard(),
        parse_mode="Markdown"
    )


async def quick_start_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞
    """
    query = update.callback_query
    await query.answer()
    
    callback_data = query.data
    
    if callback_data == "quick_start_guide":
        guide_text = """üöÄ **–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç**

–Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ —Å–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –∑–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Å—Ç—ã—Ö —à–∞–≥–æ–≤!

**–®–∞–≥ 1:** –°–æ–∑–¥–∞–π –ø—Ä–æ—Ñ–∏–ª—å –ù–ö–û (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
‚Üí –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –º–Ω–µ –ª—É—á—à–µ –ø–æ–Ω–∏–º–∞—Ç—å —Ç–≤–æ—é –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é

**–®–∞–≥ 2:** –í—ã–±–µ—Ä–∏ —Ñ—É–Ω–∫—Ü–∏—é
‚Üí üìù –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ ‚Äî –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–æ–≤
‚Üí üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ‚Äî –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–∑—É–∞–ª–æ–≤
‚Üí ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä —Ç–µ–∫—Å—Ç–∞ ‚Äî –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –≥–æ—Ç–æ–≤—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤
‚Üí üìÖ –ö–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω ‚Äî –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø—É–±–ª–∏–∫–∞—Ü–∏–π

**–®–∞–≥ 3:** –°–ª–µ–¥—É–π –ø–æ–¥—Å–∫–∞–∑–∫–∞–º
‚Üí –Ø –ø–æ–º–æ–≥—É –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ

**–ì–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å?** –í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∏–∂–µ üëá"""
        
        await query.edit_message_text(
            guide_text,
            reply_markup=get_quick_start_keyboard(),
            parse_mode="Markdown"
        )
    
    elif callback_data == "how_it_works":
        tutorial_text = """‚ùì **–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?**

**1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞:**
‚Ä¢ –í—ã–±–µ—Ä–∏ —Ç–∏–ø –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (—Å–≤–æ–±–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞, –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–∏–º–µ—Ä–æ–≤)
‚Ä¢ –û–ø–∏—à–∏ –∏–¥–µ—é –∏–ª–∏ –æ—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã
‚Ä¢ –Ø —Å–æ–∑–¥–∞–º –≥–æ—Ç–æ–≤—ã–π –ø–æ—Å—Ç —Å —Ö–µ—à—Ç–µ–≥–∞–º–∏

**2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:**
‚Ä¢ –û–ø–∏—à–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å—ã
‚Ä¢ –í—ã–±–µ—Ä–∏ —Å—Ç–∏–ª—å –∏ —Ä–∞–∑–º–µ—Ä
‚Ä¢ –ü–æ–ª—É—á–∏ –≥–æ—Ç–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ

**3. –†–µ–¥–∞–∫—Ç–æ—Ä —Ç–µ–∫—Å—Ç–∞:**
‚Ä¢ –û—Ç–ø—Ä–∞–≤—å —Ç–µ–∫—Å—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
‚Ä¢ –ü–æ–ª—É—á–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

**4. –ö–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω:**
‚Ä¢ –í—ã–±–µ—Ä–∏ –ø–µ—Ä–∏–æ–¥ –∏ —á–∞—Å—Ç–æ—Ç—É
‚Ä¢ –ü–æ–ª—É—á–∏ –≥–æ—Ç–æ–≤—ã–π –ø–ª–∞–Ω –ø—É–±–ª–∏–∫–∞—Ü–∏–π

üí° **–°–æ–≤–µ—Ç:** –ó–∞–ø–æ–ª–Ω–∏ –ø—Ä–æ—Ñ–∏–ª—å –ù–ö–û –¥–ª—è –±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞!"""
        
        await query.edit_message_text(
            tutorial_text,
            reply_markup=get_demo_examples_keyboard(),
            parse_mode="Markdown"
        )


async def show_achievements_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    query = update.callback_query
    await query.answer()
    
    user_id = update.effective_user.id
    stats = get_user_statistics(user_id)
    achievements = get_achievements(user_id, stats)
    
    text = "üèÜ **–¢–≤–æ–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è**\n\n"
    
    if achievements:
        text += "\n".join(achievements)
    else:
        text += "–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π, –Ω–æ —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ!\n\n"
        text += "–ù–∞—á–Ω–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ—Ç–∞, –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å."
    
    text += f"\n\nüìä **–¢–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**\n"
    text += f"‚Ä¢ –ü–æ—Å—Ç–æ–≤ —Å–æ–∑–¥–∞–Ω–æ: {stats['texts_count']}\n"
    text += f"‚Ä¢ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å–æ–∑–¥–∞–Ω–æ: {stats['images_count']}\n"
    text += f"‚Ä¢ –ö–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω–æ–≤: {stats['plans_count']}\n"
    text += f"‚Ä¢ –®–∞–±–ª–æ–Ω–æ–≤: {stats['templates_count']}\n"
    text += f"\nüí™ –ó–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—é:\n"
    text += f"‚Ä¢ –ü–æ—Å—Ç–æ–≤: {stats['recent_texts']}\n"
    text += f"‚Ä¢ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: {stats['recent_images']}"
    
    await query.edit_message_text(
        text,
        reply_markup=get_achievements_keyboard(),
        parse_mode="Markdown"
    )


async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
    
    –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å–æ–∑–¥–∞–µ—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç –µ–≥–æ –≤ –ë–î –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    """
    user = update.effective_user
    chat = update.effective_chat
    
    if not user:
        return
    
    # –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –ø–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
    db_user = get_or_create_user(
        user_id=user.id,
        username=user.username,
        first_name=user.first_name or "",
        last_name=user.last_name,
        language_code=user.language_code or "ru"
    )
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –ù–ö–û
    with get_db() as db:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å —á–µ—Ä–µ–∑ —Å–≤—è–∑—å User
        db_user = db.query(User).filter(User.id == user.id).first()
        if db_user and db_user.active_profile_id:
            nko_profile = db.query(NKOProfile).filter(NKOProfile.id == db_user.active_profile_id).first()
        else:
            # –ï—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è, –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π
            nko_profile = db.query(NKOProfile).filter(
                NKOProfile.user_id == user.id,
                NKOProfile.is_complete == True
            ).first()
        has_profile = nko_profile is not None and nko_profile.is_complete
    
    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    stats = get_user_statistics(user.id)
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è –¥–ª—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
    user_name = user.first_name or user.username or "–¥—Ä—É–≥"
    # –û—á–∏—â–∞–µ–º –∏–º—è –æ—Ç —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤ Markdown, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —Å–ª–æ–º–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    user_name = user_name.replace("*", "").replace("_", "").replace("[", "").replace("]", "").replace("`", "")
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    welcome_text = f"""üëã –ü—Ä–∏–≤–µ—Ç, {user_name}!

–Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Ç–≤–æ–µ–π –Ω–µ–∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏.

üéØ **–ß—Ç–æ —è —É–º–µ—é:**
‚Ä¢ üìù –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç—ã –ø–æ—Å—Ç–æ–≤ (—Å–≤–æ–±–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞, –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–∏–º–µ—Ä–æ–≤)
‚Ä¢ üé® –°–æ–∑–¥–∞–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –ø–æ—Å—Ç–æ–≤ —Å –ø–æ–º–æ—â—å—é AI
‚Ä¢ ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ —É–ª—É—á—à–∞—Ç—å —Ç–µ–∫—Å—Ç—ã (–æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—è, –≥—Ä–∞–º–º–∞—Ç–∏–∫–∞, —Å—Ç–∏–ª—å)
‚Ä¢ üìÖ –°–æ–∑–¥–∞–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω—ã –Ω–∞ –∑–∞–¥–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥

üìå **–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:**"""
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É, –µ—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    if stats["total_content"] > 0:
        welcome_text += f"\n\nüìä *–¢–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:*"
        welcome_text += f"\n‚Ä¢ –ü–æ—Å—Ç–æ–≤ —Å–æ–∑–¥–∞–Ω–æ: {stats['texts_count']}"
        welcome_text += f"\n‚Ä¢ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å–æ–∑–¥–∞–Ω–æ: {stats['images_count']}"
        
        # –ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        if stats["texts_count"] >= 10:
            welcome_text += "\n\nüéâ –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –¢—ã —É–∂–µ —Å–æ–∑–¥–∞–ª 10+ –ø–æ—Å—Ç–æ–≤!"
        elif stats["texts_count"] >= 5:
            welcome_text += "\n\nüí™ –ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ! –¢—ã —É–∂–µ –Ω–∞ –ø—É—Ç–∏ –∫ —É—Å–ø–µ—Ö—É!"
    
    if not has_profile:
        welcome_text += "\n\nüí° *–°–æ–≤–µ—Ç:* –°–æ–∑–¥–∞–π –ø—Ä–æ—Ñ–∏–ª—å —Å–≤–æ–µ–π –ù–ö–û, —á—Ç–æ–±—ã —è –º–æ–≥ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç! –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ üëá"
        await update.message.reply_text(
            welcome_text,
            reply_markup=get_main_menu_keyboard(),
            parse_mode="Markdown"
        )
        await update.message.reply_text(
            "–•–æ—á–µ—à—å —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å —Å–≤–æ–µ–π –ù–ö–û? –Ø –∑–∞–¥–∞–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤, —á—Ç–æ–±—ã –ª—É—á—à–µ –ø–æ–Ω–∏–º–∞—Ç—å —Ç–≤–æ—é –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é.",
            reply_markup=get_nko_setup_start_keyboard()
        )
    else:
        org_name = nko_profile.organization_name if nko_profile else None
        if org_name:
            welcome_text += f"\n\nüè¢ –¢–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å: *{org_name}*"
        
        await update.message.reply_text(
            welcome_text,
            reply_markup=get_main_menu_keyboard(),
            parse_mode="Markdown"
        )
    
    # –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –±—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –∏ –ø—Ä–∏–º–µ—Ä—ã –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    if stats["total_content"] == 0:
        await update.message.reply_text(
            "üöÄ *–ù–æ–≤–∏—á–æ–∫?* –ù–∞—á–Ω–∏ —Å –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞ –∏–ª–∏ –ø–æ—Å–º–æ—Ç—Ä–∏ –ø—Ä–∏–º–µ—Ä—ã!",
            reply_markup=get_quick_start_keyboard(include_demos=True),
            parse_mode="Markdown"
        )
    
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.id} ({user.username or user.first_name}) –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞")
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–ª–∞–≥, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–æ–ª—å–∫–æ —á—Ç–æ –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞
    # –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ—Å–ª–µ /start
    context.user_data['_started_recently'] = True


async def handle_voice_after_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ—Å–ª–µ /start
    
    –†–∞—Å–ø–æ–∑–Ω–∞–µ—Ç –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–∏
    """
    if not update.message.voice:
        return None
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ –Ω–µ–¥–∞–≤–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω /start
    if not context.user_data.get('_started_recently'):
        return None
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –±–µ—Å–µ–¥—ã (ConversationHandler)
    # –ï—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –±–µ—Å–µ–¥–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É, —á—Ç–æ–±—ã ConversationHandler –º–æ–≥ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ
    if context.user_data.get('_conversation_active'):
        logger.info("ConversationHandler –∞–∫—Ç–∏–≤–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –ø–æ—Å–ª–µ /start")
        return None
    
    user = update.effective_user
    logger.info(f"–ü–æ–ª—É—á–µ–Ω–æ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ /start –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id}")
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏
    processing_msg = await update.message.reply_text(
        "üé§ –†–∞—Å–ø–æ–∑–Ω–∞—é –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...\n\n"
        "–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥."
    )
    
    try:
        # –†–∞—Å–ø–æ–∑–Ω–∞–µ–º —Ä–µ—á—å
        transcribed_text = await speech_recognition_service.transcribe_voice_message(
            voice_file_id=update.message.voice.file_id,
            bot=context.bot
        )
        
        if not transcribed_text or len(transcribed_text.strip()) < 3:
            await processing_msg.edit_text(
                "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.\n\n"
                "–ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é."
            )
            context.user_data.pop('_started_recently', None)
            return None
        
        transcribed_text = transcribed_text.strip()
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é
        await processing_msg.edit_text(
            f"‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: *{transcribed_text}*\n\n"
            "–û–ø—Ä–µ–¥–µ–ª—è—é –Ω–∞–º–µ—Ä–µ–Ω–∏–µ...",
            parse_mode="Markdown"
        )
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–º–µ—Ä–µ–Ω–∏–µ
        intent_result = await speech_recognition_service.detect_intent(transcribed_text)
        intent = intent_result.get('intent', 'other')
        
        logger.info(f"–û–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –Ω–∞–º–µ—Ä–µ–Ω–∏–µ: {intent}")
        
        # –£–±–∏—Ä–∞–µ–º —Ñ–ª–∞–≥
        context.user_data.pop('_started_recently', None)
        
        # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–∏
        if intent == "text_generation":
            await processing_msg.edit_text(
                f"‚úÖ –ü–æ–Ω—è–ª! –¢—ã —Ö–æ—á–µ—à—å —Å–æ–∑–¥–∞—Ç—å —Ç–µ–∫—Å—Ç.\n\n"
                f"–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: *{transcribed_text}*\n\n"
                "–ü–µ—Ä–µ—Ö–æ–∂—É –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞...",
                parse_mode="Markdown"
            )
            
            # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞
            from bot.handlers.text_generation import show_text_generation_menu
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
            context.user_data['free_text'] = transcribed_text
            context.user_data['text_gen_mode'] = 'free'
            context.user_data['_conversation_active'] = True
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞
            await update.message.reply_text(
                "üìù **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞**\n\n"
                f"–¢–≤–æ—è –∏–¥–µ—è: *{transcribed_text}*\n\n"
                "–í—ã–±–µ—Ä–∏ —Å–ø–æ—Å–æ–± –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:",
                reply_markup=None,
                parse_mode="Markdown"
            )
            
            # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º —Å–≤–æ–±–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç
            from bot.handlers.text_generation import text_generation_type_callback
            from telegram import CallbackQuery
            
            # –°–æ–∑–¥–∞–µ–º —Ñ–∏–∫—Ç–∏–≤–Ω—ã–π callback query
            fake_query = type('obj', (object,), {
                'data': 'text_gen_free',
                'answer': lambda: None,
                'edit_message_text': lambda text, **kwargs: update.message.reply_text(text, **kwargs)
            })()
            
            fake_update = type('obj', (object,), {
                'callback_query': fake_query,
                'effective_user': update.effective_user
            })()
            
            return await text_generation_type_callback(fake_update, context)
            
        elif intent == "image_generation":
            await processing_msg.edit_text(
                f"‚úÖ –ü–æ–Ω—è–ª! –¢—ã —Ö–æ—á–µ—à—å —Å–æ–∑–¥–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.\n\n"
                f"–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: *{transcribed_text}*\n\n"
                "–ü–µ—Ä–µ—Ö–æ–∂—É –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...",
                parse_mode="Markdown"
            )
            
            # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            from bot.handlers.image_generation import show_image_generation_menu
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
            context.user_data['image_gen'] = {'description': transcribed_text}
            context.user_data['_conversation_active'] = True
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –∏ —Å—Ä–∞–∑—É –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
            await update.message.reply_text(
                f"üé® **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è**\n\n"
                f"–û–ø–∏—Å–∞–Ω–∏–µ: *{transcribed_text}*\n\n"
                "–ì–µ–Ω–µ—Ä–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...",
                parse_mode="Markdown"
            )
            
            # –í—ã–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–ø–∏—Å–∞–Ω–∏—è –Ω–∞–ø—Ä—è–º—É—é
            from bot.handlers.image_generation import handle_image_description
            return await handle_image_description(update, context)
            
        else:
            await processing_msg.edit_text(
                f"‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: *{transcribed_text}*\n\n"
                "–ù–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª, —á—Ç–æ —Ç—ã —Ö–æ—á–µ—à—å —Å–¥–µ–ª–∞—Ç—å.\n\n"
                "–ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –∏–ª–∏ —Å–∫–∞–∂–∏:\n"
                "‚Ä¢ \"—Ö–æ—á—É —Å–æ–∑–¥–∞—Ç—å —Ç–µ–∫—Å—Ç\" –∏–ª–∏ \"—Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π —Ç–µ–∫—Å—Ç\"\n"
                "‚Ä¢ \"—Ö–æ—á—É —Å–æ–∑–¥–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ\" –∏–ª–∏ \"—Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ\"",
                parse_mode="Markdown",
                reply_markup=get_main_menu_keyboard()
            )
            return None
            
    except Exception as e:
        logger.exception(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –ø–æ—Å–ª–µ /start: {e}")
        await processing_msg.edit_text(
            "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.\n\n"
            "–ü–æ–ø—Ä–æ–±—É–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é.",
            reply_markup=get_main_menu_keyboard()
        )
        context.user_data.pop('_started_recently', None)
        return None


async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help
    
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø—Ä–∞–≤–∫—É –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–æ—Ç–∞
    """
    help_text = """üìö **–°–ø—Ä–∞–≤–∫–∞ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–æ—Ç–∞**

üéØ **–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

üìù **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞**
‚Ä¢ –°–≤–æ–±–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç - –≤–≤–µ–¥–∏ –∏–¥–µ—é, —è –ø–µ—Ä–µ–ø–∏—à—É –µ—ë –≤ –≥–æ—Ç–æ–≤—ã–π –ø–æ—Å—Ç
‚Ä¢ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞ - –æ—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, —è —Å–æ–∑–¥–∞–º –ø–æ—Å—Ç
‚Ä¢ –ù–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–∏–º–µ—Ä–æ–≤ - –ø—Ä–∏—à–ª–∏ –ø—Ä–∏–º–µ—Ä—ã –ø–æ—Å—Ç–æ–≤, —è —Å–æ–∑–¥–∞–º –ø–æ—Ö–æ–∂–∏–π —Å—Ç–∏–ª—å

üé® **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è**
‚Ä¢ –û–ø–∏—à–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å—ã
‚Ä¢ –í—ã–±–µ—Ä–∏ —Å—Ç–∏–ª—å –∏ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω
‚Ä¢ –ü–æ–ª—É—á–∏ –≥–æ—Ç–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ

‚úèÔ∏è **–†–µ–¥–∞–∫—Ç–æ—Ä —Ç–µ–∫—Å—Ç–∞**
‚Ä¢ –ü—Ä–∏—à–ª–∏ —Ç–µ–∫—Å—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
‚Ä¢ –ü–æ–ª—É—á–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é

üìÖ **–ö–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω**
‚Ä¢ –í—ã–±–µ—Ä–∏ –ø–µ—Ä–∏–æ–¥ –∏ —á–∞—Å—Ç–æ—Ç—É –ø—É–±–ª–∏–∫–∞—Ü–∏–π
‚Ä¢ –ü–æ–ª—É—á–∏ –≥–æ—Ç–æ–≤—ã–π –ø–ª–∞–Ω –ø—É–±–ª–∏–∫–∞—Ü–∏–π

üìä **–ò—Å—Ç–æ—Ä–∏—è**
‚Ä¢ –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π –≤—Å–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
‚Ä¢ –°–æ—Ö—Ä–∞–Ω—è–π –∏–∑–±—Ä–∞–Ω–Ω–æ–µ

‚öôÔ∏è **–ù–∞—Å—Ç—Ä–æ–π–∫–∏**
‚Ä¢ –ù–∞—Å—Ç—Ä–æ–π –ø—Ä–æ—Ñ–∏–ª—å –ù–ö–û
‚Ä¢ –í–∫–ª—é—á–∏/–≤—ã–∫–ª—é—á–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –ø—É–±–ª–∏–∫–∞—Ü–∏—è—Ö

üí° **–°–æ–≤–µ—Ç—ã:**
‚Ä¢ –ó–∞–ø–æ–ª–Ω–∏ –ø—Ä–æ—Ñ–∏–ª—å –ù–ö–û –¥–ª—è –±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–Ω—ã–µ —Å—Ç–∏–ª–∏ –Ω–∞–ø–∏—Å–∞–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
‚Ä¢ –°–æ—Ö—Ä–∞–Ω—è–π –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è –ø–æ—Å—Ç—ã –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ

‚ùì –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã, –Ω–∞–ø–∏—à–∏ /start –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
    
    await update.message.reply_text(help_text, parse_mode="Markdown")


async def about_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–û –±–æ—Ç–µ"
    """
    about_text = """‚ÑπÔ∏è **–û –±–æ—Ç–µ**

–Ø - Telegram-–±–æ—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –Ω–µ–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π.

üéØ **–¶–µ–ª—å –ø—Ä–æ–µ–∫—Ç–∞:**
–ü–æ–º–æ—á—å –ù–ö–û —Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π –∏ —Å–∞–π—Ç–æ–≤, —ç–∫–æ–Ω–æ–º—è –≤—Ä–µ–º—è –∏ —É—Å–∏–ª–∏—è.

‚ú® **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –∏ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö AI-–º–æ–¥–µ–ª–µ–π
‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
‚Ä¢ –ü—Ä–æ—Å—Ç–æ–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
‚Ä¢ –ú–∏–Ω–∏–º—É–º –∫–ª–∏–∫–æ–≤ - –º–∞–∫—Å–∏–º—É–º –ø–æ–ª—å–∑—ã

üí° **–î–ª—è –∫–æ–≥–æ:**
‚Ä¢ –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –ù–ö–û
‚Ä¢ –í–æ–ª–æ–Ω—Ç—ë—Ä—ã
‚Ä¢ SMM-–º–µ–Ω–µ–¥–∂–µ—Ä—ã –Ω–µ–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤

üìå –†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ –¥–ª—è —Ö–∞–∫–∞—Ç–æ–Ω–∞ –ø–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã –ù–ö–û"""
    
    await update.message.reply_text(about_text, parse_mode="Markdown")

